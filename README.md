# Local Volume Mapper Data Analysis Pipeline (LVM-DAP)

## Introduction
The **LVM-DAP** is the official data analysis pipeline for the **SDSS-V Local Volume Mapper (LVM)**. It provides routines and scripts to analyze and fit spectral data from LVM observations.

### Main Scripts:
- **`lvm-dap-conf`**: Fits FITS files in LVM format using a predefined configuration file.
- **`lvm-dap-gen-out-mod`**: Generates output models from spectral data.
- **`lvm-dap-sim`**: Simulates spectral data based on predefined parameters.
- **`lvm-dap`**: Runs spectral fitting for LVM data.

---
## Installation

### Recommended Setup
It is recommended to install **LVM-DAP** in a virtual environment to avoid dependency issues. Options include:
- [Miniconda](https://docs.conda.io/en/latest/miniconda.html)
- [venv](https://docs.python.org/3.8/library/venv.html) (Recommended)
- [pipenv](https://pipenv.pypa.io/en/latest/)

### Prerequisites
**LVM-DAP** depends on **pyPipe3D** ([pyPipe3D](http://ifs.astroscu.unam.mx/pyPipe3D/), Lacerda et al. 2022). Install pyPipe3D before proceeding.

### Installation Steps
```bash
# Create and activate a Conda environment
conda create --name lvmdap python=3.11
conda activate lvmdap

# Install required dependencies
conda install numpy=1.23.5  # Avoid compatibility issues
# OR
pip install numpy==1.23.5

# Install pyPipe3D
git clone https://gitlab.com/pipe3d/pyPipe3D.git
cd pyPipe3D
pip install . --user
cd ..

# Install LVM-DAP
git clone https://github.com/sdss/lvmdap.git
cd lvmdap
pip install . --user
```

### Additional Data
Download and store the required fitting data from:
[Download LVM fitting data](https://tinyurl.com/mudr6yw7)

### Environmental Variables
Define the following environment variables:
```bash
export LVM_DAP="/path/to/lvmdap"  # LVM-DAP installation directory
export LVM_DAP_CFG="$LVM_DAP/_legacy"  # Configuration files directory
export LVM_DAP_RSP="_fitting_data"  # Stellar templates directory
```

### Directory Structure
After a successful installation, the directory should be structured as follows:
```
├── dist
├── lvmdap
├── _examples
├── _fitting_data
├── _legacy    
├── notebooks
├── poetry.lock
├── pyproject.toml
├── README.md
├── README.rst
└── setup.py
```

---
## Running Tests
### Test 1: Running Example Script
```bash
cd _examples/
chmod +x fit_6109_strong.sh
./fit_6109_strong.sh
```

### Test 2: Running DAP on a FITS File
1. Download the example FITS file:
   - [Download example FITS](https://tinyurl.com/mudr6yw7)
2. Place it inside `_examples/data/`
3. Run the following command:
```bash
lvm-dap-conf _examples/data/lvmSFrame-example.fits.gz dap-4-example _legacy/lvm-dap_fast.yaml
```
---
## Usage
### `lvm-dap-conf` Command

#### Example YAML Configuration
```yaml
auto-redshift: True
auto_z_min: -0.005
auto_z_max: 0.01
auto_z_del: 0.0001
auto_z_bg: True
auto_z_sc: True
#auto_z_del: 0.00001
# auto-redshift: False
sky-hack: False
SN_CUT: 20
SN_CUT_INT: 0.1
```

```bash
lvm-dap-conf [-h] [-d] lvm_file label config_yaml
```
- **`lvm_file`**: FITS file in LVM format
- **`label`**: Label for the current run
- **`config_yaml`**: Configuration file for fitting parameters

### `lvm-dap-gen-out-mod` Command
```bash
lvm-dap-gen-out-mod [-h] [-d] [-output_path OUTPUT_PATH] [--plot PLOT] [--flux-scale min max] lvm_file DAP_table_in label config_yaml
```
- **`lvm_file`**: Input LVM spectrum that was fitted
- **`DAP_table_in`**: DAP file generated by the LVM-DAP fitting
- **`label`**: Label for the output file (e.g., LABEL.output.fits.gz)
- **`config_yaml`**: Configuration file with fitting parameters

**Options:**
- `-d, --debug` : Enable debugging mode (default: False)
- `-output_path OUTPUT_PATH` : Directory to store the results
- `--plot PLOT` : Whether to plot (1) or not (0, default). If 2, saves a plot without displaying on screen
- `--flux-scale min max` : Scale of the flux in the input spectrum

### `lvm-dap-sim` Command
```bash
lvm-dap-sim [-h] [-n_sim n_sim] [-n_st n_st] [-f_st f_scale_st] [-f_el f_scale_el] [-dap_fwhm dap_fwhm] [-d] lvm_file label config_yaml
```
- **`lvm_file`**: Input LVM spectrum for the simulation
- **`label`**: Label for the current run
- **`config_yaml`**: Configuration file with fitting parameters

**Options:**
- `-h, --help` : Show help message and exit
- `-n_sim n_sim` : Number of simulated spectra (default: 10)
- `-n_st n_st` : Number of stars included in the model (default: 10)
- `-f_st f_scale_st` : Scaling factor applied to stellar population spectra (~S/N level, default: 1.0)
- `-f_el f_scale_el` : Scaling factor applied to emission lines relative to reference (default: 1.0)
- `-dap_fwhm dap_fwhm` : Scaling factor applied to DAP non-parametric dispersion for emission lines (default: 2.354)
- `-d, --debug` : Enable debugging mode (default: False)

### `lvm-dap` Command (Deprecated)

`lvm-dap` is now deprecated. Users are encouraged to use `lvm-dap-conf`, `lvm-dap-gen-out-mod`, or `lvm-dap-sim` instead.
```bash
lvm-dap [-h] [--config-file CONFIG_FILE] spectrum-file rsp-file sigma-inst label
```
- **`spectrum-file`**: Input spectrum to fit
- **`rsp-file`**: The resolved stellar population basis
- **`sigma-inst`**: The resolution downgrade parameter
- **`label`**: Label for the run

---
## Troubleshooting & Additional Notes
- If you encounter installation issues, check **numpy version** compatibility.
- Ensure **pyPipe3D** is installed **before** LVM-DAP.
- For support, refer to the **[official repository](https://github.com/sdss/lvmdap)**.

---
## References
- SDSS-V Local Volume Mapper: [LVM Project](https://www.sdss.org/sdss5/instruments/lvm/)
- [pyPipe3D Documentation](http://ifs.astroscu.unam.mx/pyPipe3D/)

